<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACI 318-19 Wall Design</title>
    <style>
        :root{--bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--card:#1c2128;--blue:#58a6ff;--green:#3fb950;--orange:#d29922;--red:#f85149;--purple:#a371f7;--cyan:#39d353;--text:#e6edf3;--text2:#8b949e;--text3:#6e7681;--border:#30363d}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .app{display:grid;grid-template-columns:340px 1fr;min-height:100vh}
        .sidebar{background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;height:100vh;position:sticky;top:0}
        .header{padding:16px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,#1f6feb22,#8957e522)}
        .logo{display:flex;align-items:center;gap:10px}
        .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--blue),var(--purple));border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px}
        .section{padding:14px 16px;border-bottom:1px solid var(--border)}
        .section-title{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--blue);margin-bottom:12px}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
        .group{margin-bottom:10px}
        label{display:block;font-size:11px;color:var(--text2);margin-bottom:3px}
        input,select{width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:monospace;font-size:12px}
        input:focus,select:focus{outline:none;border-color:var(--blue)}
        .hint{font-size:9px;color:var(--text3);margin-top:2px}
        .btn{width:100%;padding:11px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;margin-top:6px}
        .btn-primary{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff}
        .btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
        .main{padding:20px;overflow-y:auto}
        .results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .title{font-size:20px;font-weight:700}
        .badge{padding:5px 12px;border-radius:12px;font-size:10px;font-weight:600;text-transform:uppercase}
        .badge-pass{background:rgba(63,185,80,.15);color:var(--green);border:1px solid rgba(63,185,80,.3)}
        .badge-fail{background:rgba(248,81,73,.15);color:var(--red);border:1px solid rgba(248,81,73,.3)}
        .badge-warn{background:rgba(210,153,34,.15);color:var(--orange);border:1px solid rgba(210,153,34,.3)}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-bottom:16px}
        .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .card-title{font-size:10px;font-weight:600;color:var(--text2);text-transform:uppercase}
        .card-icon{width:26px;height:26px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:12px}
        .icon-blue{background:rgba(88,166,255,.15);color:var(--blue)}
        .icon-green{background:rgba(63,185,80,.15);color:var(--green)}
        .icon-orange{background:rgba(210,153,34,.15);color:var(--orange)}
        .icon-purple{background:rgba(163,113,247,.15);color:var(--purple)}
        .icon-cyan{background:rgba(57,211,83,.15);color:var(--cyan)}
        .card-value{font-size:22px;font-weight:700;font-family:monospace}
        .card-detail{font-size:10px;color:var(--text3)}
        .ratio-bar{height:4px;background:var(--bg3);border-radius:2px;margin-top:8px;overflow:hidden}
        .ratio-fill{height:100%;border-radius:2px;transition:width .3s}
        .ratio-safe{background:var(--green)}
        .ratio-warn{background:var(--orange)}
        .ratio-fail{background:var(--red)}
        .tabs{display:flex;gap:3px;margin-bottom:14px;background:var(--bg3);padding:3px;border-radius:6px;width:fit-content;flex-wrap:wrap}
        .tab{padding:7px 14px;border-radius:5px;font-size:11px;font-weight:500;cursor:pointer;color:var(--text2);border:none;background:transparent}
        .tab:hover{color:var(--text)}
        .tab.active{background:var(--blue);color:#fff}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .pm-container{display:grid;grid-template-columns:1fr 240px;gap:16px}
        .pm-chart{background:var(--bg);border-radius:8px;padding:12px}
        .pm-legend{background:var(--bg3);border-radius:8px;padding:12px}
        .legend-title{font-size:10px;font-weight:600;color:var(--text2);margin-bottom:8px;text-transform:uppercase}
        .legend-item{display:flex;align-items:center;gap:6px;padding:5px 0;border-bottom:1px solid var(--border);font-size:11px;color:var(--text2)}
        .legend-dot{width:8px;height:8px;border-radius:50%}
        .key-point{margin-bottom:5px}
        .key-label{font-size:9px;color:var(--text3);text-transform:uppercase}
        .key-value{font-family:monospace;font-size:11px}
        .calc-section{margin-bottom:16px}
        .calc-title{font-size:12px;font-weight:600;color:var(--blue);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)}
        .calc-line{font-family:monospace;font-size:11px;line-height:1.8;color:var(--text2)}
        .result{color:var(--blue);font-weight:600}
        .pass{color:var(--green)}
        .fail{color:var(--red)}
        .warn{color:var(--orange)}
        .placeholder{text-align:center;padding:60px;color:var(--text3)}
        .placeholder-icon{font-size:48px;margin-bottom:12px}
        .check{display:flex;align-items:center;gap:6px;margin-bottom:8px}
        .check input{width:14px;height:14px}
        .deflection-diagram{background:var(--bg);border-radius:8px;padding:16px;margin-top:12px}
        .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        @media(max-width:1100px){.app{grid-template-columns:1fr}.sidebar{position:relative;height:auto}.pm-container{grid-template-columns:1fr}.two-col{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="app">
    <aside class="sidebar">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">W</div>
                <div><div style="font-size:16px;font-weight:700">Wall Design</div><div style="font-size:10px;color:var(--text2)">ACI 318-19</div></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Geometry</div>
            <div class="row">
                <div class="group"><label>Length Lw (in)</label><input type="number" id="Lw" value="240"></div>
                <div class="group"><label>Thickness t (in)</label><input type="number" id="t" value="12"></div>
            </div>
            <div class="row">
                <div class="group"><label>Height Hw (in)</label><input type="number" id="Hw" value="144"></div>
                <div class="group"><label>Clear Height lc (in)</label><input type="number" id="lc" value="144"></div>
            </div>
            <div class="group"><label>Boundary k</label>
                <select id="k"><option value="0.8">Both ends (k=0.8)</option><option value="1.0" selected>One end (k=1.0)</option><option value="2.0">Cantilever (k=2.0)</option></select>
            </div>
            <div class="check"><input type="checkbox" id="asColumn"><label style="margin:0">Design as Column</label></div>
        </div>
        <div class="section">
            <div class="section-title">Materials</div>
            <div class="row">
                <div class="group"><label>f'c (psi)</label><input type="number" id="fc" value="4000"></div>
                <div class="group"><label>fy (psi)</label><input type="number" id="fy" value="60000"></div>
            </div>
            <div class="group"><label>Concrete Type</label>
                <select id="lambda"><option value="1.0" selected>Normal (Œª=1.0)</option><option value="0.85">Sand-LW (Œª=0.85)</option><option value="0.75">Lightweight (Œª=0.75)</option></select>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Reinforcement</div>
            <div class="row">
                <div class="group"><label>Vert. Bar</label>
                    <select id="vBar"><option value="4">#4</option><option value="5" selected>#5</option><option value="6">#6</option><option value="7">#7</option><option value="8">#8</option><option value="9">#9</option><option value="10">#10</option></select>
                </div>
                <div class="group"><label>Spacing (in)</label><input type="number" id="vSpac" value="12"></div>
            </div>
            <div class="row">
                <div class="group"><label>Layers</label><select id="vLay"><option value="1">Single</option><option value="2" selected>Double</option></select></div>
                <div class="group"><label>Cover (in)</label><input type="number" id="cover" value="1.5"></div>
            </div>
            <div class="row">
                <div class="group"><label>Horiz. Bar</label>
                    <select id="hBar"><option value="4" selected>#4</option><option value="5">#5</option><option value="6">#6</option></select>
                </div>
                <div class="group"><label>Spacing (in)</label><input type="number" id="hSpac" value="12"></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Factored Loads (Strength)</div>
            <div class="row">
                <div class="group"><label>Pu (kips)</label><input type="number" id="Pu" value="500"></div>
                <div class="group"><label>Mu,ip (kip-ft)</label><input type="number" id="MuIP" value="2000"></div>
            </div>
            <div class="row">
                <div class="group"><label>Vu,ip (kips)</label><input type="number" id="VuIP" value="150"></div>
                <div class="group"><label>Mu,op (k-ft/ft)</label><input type="number" id="MuOP" value="50"></div>
            </div>
            <div class="group"><label>Vu,op (kips/ft)</label><input type="number" id="VuOP" value="5"></div>
        </div>
        <div class="section">
            <div class="section-title">Service Loads (Deflection)</div>
            <div class="row">
                <div class="group"><label>Pa,service (kips)</label><input type="number" id="Pa_svc" value="350"><div class="hint">Axial per ft width</div></div>
                <div class="group"><label>Ma,op,svc (k-ft/ft)</label><input type="number" id="Ma_svc" value="35"><div class="hint">Out-of-plane</div></div>
            </div>
            <div class="group"><label>Deflection Limit</label>
                <select id="deflLimit"><option value="180">L/180 (Floor)</option><option value="240" selected>L/240 (General)</option><option value="360">L/360 (Sensitive)</option><option value="480">L/480 (Strict)</option></select>
            </div>
        </div>
        <div class="section">
            <button class="btn btn-primary" onclick="calc()">‚ñ∂ Calculate</button>
            <button class="btn btn-secondary" onclick="exportPDF()">üìÑ Export Report</button>
        </div>
    </aside>
    <main class="main">
        <div id="placeholder" class="placeholder">
            <div class="placeholder-icon">üèóÔ∏è</div>
            <div>Enter parameters and click Calculate</div>
        </div>
        <div id="results" style="display:none">
            <div class="results-header">
                <h1 class="title">Design Results</h1>
                <span class="badge" id="status">--</span>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="showTab('summary')">Summary</button>
                <button class="tab" onclick="showTab('inplane')">In-Plane</button>
                <button class="tab" onclick="showTab('outplane')">Out-of-Plane</button>
                <button class="tab" onclick="showTab('slender')">Slenderness</button>
                <button class="tab" onclick="showTab('pm')">P-M (In-Plane)</button>
                <button class="tab" onclick="showTab('pmop')">P-M (Out-Plane)</button>
                <button class="tab" onclick="showTab('report')">Report</button>
            </div>
            <div class="tab-content active" id="tab-summary">
                <div class="grid" id="summaryGrid"></div>
                <div class="card" id="propsCard"></div>
            </div>
            <div class="tab-content" id="tab-inplane"><div class="card" id="inplaneCard"></div></div>
            <div class="tab-content" id="tab-outplane">
                <div class="two-col">
                    <div class="card" id="outplaneCard"></div>
                    <div class="card" id="deflectionCard"></div>
                </div>
            </div>
            <div class="tab-content" id="tab-slender"><div class="card" id="slenderCard"></div></div>
            <div class="tab-content" id="tab-pm">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <div style="font-weight:600">P-M Interaction (In-Plane / Strong Axis)</div>
                        <span class="badge" id="pmStatus">--</span>
                    </div>
                    <div class="pm-container">
                        <div class="pm-chart"><canvas id="pmCanvas" width="520" height="380"></canvas></div>
                        <div class="pm-legend">
                            <div class="legend-title">Legend</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#58a6ff"></div>œÜPn-œÜMn</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#3fb950"></div>Nominal</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#f85149"></div>Applied</div>
                            <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                                <div class="legend-title">Key Points</div>
                                <div class="key-point"><div class="key-label">Pure Comp.</div><div class="key-value" id="pmComp">--</div></div>
                                <div class="key-point"><div class="key-label">Balanced</div><div class="key-value" id="pmBal">--</div></div>
                                <div class="key-point"><div class="key-label">Pure Bend.</div><div class="key-value" id="pmBend">--</div></div>
                                <div class="key-point"><div class="key-label">Pure Tens.</div><div class="key-value" id="pmTens">--</div></div>
                                <div class="key-point" style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)"><div class="key-label">Applied</div><div class="key-value" id="pmApp">--</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="tab-pmop">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <div style="font-weight:600">P-M Interaction (Out-of-Plane / Weak Axis) - Per Foot Width</div>
                        <span class="badge" id="pmopStatus">--</span>
                    </div>
                    <div class="pm-container">
                        <div class="pm-chart"><canvas id="pmopCanvas" width="520" height="380"></canvas></div>
                        <div class="pm-legend">
                            <div class="legend-title">Legend</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#a371f7"></div>œÜPn-œÜMn</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#39d353"></div>Nominal</div>
                            <div class="legend-item"><div class="legend-dot" style="background:#f85149"></div>Applied</div>
                            <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                                <div class="legend-title">Key Points (per ft)</div>
                                <div class="key-point"><div class="key-label">Pure Comp.</div><div class="key-value" id="pmopComp">--</div></div>
                                <div class="key-point"><div class="key-label">Balanced</div><div class="key-value" id="pmopBal">--</div></div>
                                <div class="key-point"><div class="key-label">Pure Bend.</div><div class="key-value" id="pmopBend">--</div></div>
                                <div class="key-point"><div class="key-label">Pure Tens.</div><div class="key-value" id="pmopTens">--</div></div>
                                <div class="key-point" style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)"><div class="key-label">Applied</div><div class="key-value" id="pmopApp">--</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="tab-report"><div class="card" id="reportCard"></div></div>
        </div>
    </main>
</div>
<script>
const Ab={4:.20,5:.31,6:.44,7:.60,8:.79,9:1.00,10:1.27,11:1.56};
const db={4:.5,5:.625,6:.75,7:.875,8:1,9:1.128,10:1.27,11:1.41};
let R={};

function showTab(id){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelector(`.tab[onclick="showTab('${id}')"]`).classList.add('active');
    document.getElementById('tab-'+id).classList.add('active');
    if(id==='pm'&&R.pm)drawPM();
    if(id==='pmop'&&R.pmOP)drawPMOP();
}

function calc(){
    const g=id=>parseFloat(document.getElementById(id).value);
    const Lw=g('Lw'),t=g('t'),Hw=g('Hw'),lc=g('lc'),k=g('k');
    const fc=g('fc'),fy=g('fy'),lambda=g('lambda');
    const vBar=+document.getElementById('vBar').value,vSpac=g('vSpac'),vLay=+document.getElementById('vLay').value;
    const hBar=+document.getElementById('hBar').value,hSpac=g('hSpac'),cover=g('cover');
    const Pu=g('Pu'),MuIP=g('MuIP'),VuIP=g('VuIP'),MuOP=g('MuOP'),VuOP=g('VuOP');
    const Pa_svc=g('Pa_svc'),Ma_svc=g('Ma_svc');
    const deflLimit=+document.getElementById('deflLimit').value;
    const asCol=document.getElementById('asColumn').checked;

    const Ec=57000*Math.sqrt(fc); // psi
    const Es=29000000;
    const n=Es/Ec;

    const Ag=Lw*t;
    const Ag_ft=12*t; // per ft width
    const nBars=Math.floor(Lw/vSpac)+1;
    const As=nBars*Ab[vBar]*vLay;
    const AsPerFt=(12/vSpac)*Ab[vBar]*vLay;
    const AsH=(Hw/hSpac)*Ab[hBar]*vLay;
    const rhoV=As/Ag,rhoH=AsH/Ag;
    const d=Lw-cover-db[hBar]-db[vBar]/2;
    const dOP=t-cover-db[hBar]-db[vBar]/2;
    const AR=Hw/Lw;

    // Ig and Icr for out-of-plane (per ft width)
    const b=12; // per foot
    const Ig=b*Math.pow(t,3)/12;
    // Cracked moment of inertia (transformed section)
    const rho_op=AsPerFt/(b*dOP);
    const kCr=Math.sqrt(2*rho_op*n+Math.pow(rho_op*n,2))-rho_op*n;
    const Icr=b*Math.pow(kCr*dOP,3)/3+n*AsPerFt*Math.pow(dOP-kCr*dOP,2);
    
    // Cracking moment
    const fr=7.5*lambda*Math.sqrt(fc); // psi
    const Mcr=fr*Ig/(t/2)/12000; // kip-ft/ft

    // Effective moment of inertia (Branson's equation)
    const Ma=Ma_svc; // service moment kip-ft/ft
    let Ie;
    if(Ma<=Mcr){
        Ie=Ig;
    }else{
        Ie=Math.min(Ig,Math.pow(Mcr/Ma,3)*Ig+(1-Math.pow(Mcr/Ma,3))*Icr);
    }

    // Deflection calculation (simply supported with uniform moment approx)
    const L_in=lc;
    // For uniform load: delta = 5*w*L^4/(384*E*I) or for moment: delta = M*L^2/(8*E*I)
    // Using M*L^2/(8*E*I) for pure moment case
    const delta_calc=Ma*12000*Math.pow(L_in,2)/(8*Ec*Ie); // inches
    const delta_allow=L_in/deflLimit;
    const deflOK=delta_calc<=delta_allow;

    // Slenderness
    const klc_t=k*lc/t;
    const slenderOK=klc_t<=25;
    const Cr=Math.max(0,1-Math.pow(klc_t/32,2));

    // Axial
    const phiA=0.65;
    let phiPn;
    if(asCol||Lw<=3*t){
        const Pn0=0.85*fc*(Ag-As)+fy*As;
        phiPn=phiA*0.8*Pn0/1000;
    }else{
        phiPn=0.55*phiA*fc*Ag*Math.max(0,1-Math.pow(k*lc/(32*t),2))/1000;
    }

    // In-plane flexure
    const a=As*fy/(0.85*fc*t);
    const Mn=As*fy*(d-a/2)/12000;
    const phiMn=0.9*Mn;

    // In-plane shear
    const Acv=Lw*t;
    const alphaC=AR<=1.5?3:AR>=2?2:3-(AR-1.5)*2;
    const Vc=alphaC*lambda*Math.sqrt(fc)*Acv/1000;
    const AvH=AsPerFt*Lw/12;
    const Vs=AvH*fy*d/(hSpac*1000);
    const VnMax=8*Math.sqrt(fc)*Acv/1000;
    const Vn=Math.min(Vc+Vs,VnMax);
    const phiVn=0.75*Vn;

    // Out-of-plane flexure
    const aOP=AsPerFt*fy/(0.85*fc*12);
    const MnOP=AsPerFt*fy*(dOP-aOP/2)/12000;
    const phiMnOP=0.9*MnOP;
    const VcOP=2*lambda*Math.sqrt(fc)*12*dOP/1000;
    const phiVcOP=0.75*VcOP;

    // Min reinf
    const rhoVmin=(vBar<=5&&fy>=60000)?0.0012:0.0015;
    const rhoHmin=(vBar<=5&&fy>=60000)?0.002:0.0025;

    // Ratios
    const rAxial=Pu/phiPn;
    const rMomIP=MuIP/phiMn;
    const rShearIP=VuIP/phiVn;
    const rMomOP=MuOP/phiMnOP;
    const rShearOP=VuOP/phiVcOP;
    const rDefl=delta_calc/delta_allow;

    // P-M curve (In-plane)
    const pm=calcPM_IP(Lw,t,fc,fy,As,nBars,cover,db[hBar],db[vBar],vSpac,vLay);
    const pmCheck=checkPM(pm,Pu,MuIP);

    // P-M curve (Out-of-plane) per foot width
    const PuPerFt=Pu/Lw*12; // axial per ft
    const pmOP=calcPM_OP(t,fc,fy,AsPerFt,cover,db[hBar],db[vBar],vLay);
    const pmopCheck=checkPM(pmOP,PuPerFt,MuOP);

    R={Lw,t,Hw,lc,k,fc,fy,lambda,vBar,vSpac,vLay,hBar,hSpac,cover,Pu,MuIP,VuIP,MuOP,VuOP,asCol,
       Pa_svc,Ma_svc,deflLimit,Ec,Es,n,
       Ag,Ag_ft,nBars,As,AsPerFt,AsH,rhoV,rhoH,d,dOP,AR,
       Ig,Icr,Ie,Mcr,fr,kCr,delta_calc,delta_allow,deflOK,
       klc_t,slenderOK,Cr,phiPn,a,Mn,phiMn,
       Acv,alphaC,Vc,Vs,VnMax,Vn,phiVn,aOP,MnOP,phiMnOP,VcOP,phiVcOP,
       rhoVmin,rhoHmin,rAxial,rMomIP,rShearIP,rMomOP,rShearOP,rDefl,
       pm,pmCheck,pmOP,pmopCheck,PuPerFt};

    updateUI();
}

function calcPM_IP(Lw,t,fc,fy,As,nBars,cover,dbH,dbV,spacing,layers){
    const pts=[],nom=[];
    const Es=29e6,ecu=0.003;
    const b1=Math.max(0.65,Math.min(0.85,0.85-0.05*(fc-4000)/1000));
    const d1=cover+dbH+dbV/2;
    const bars=[];
    for(let i=0;i<nBars;i++){const x=d1+i*spacing;if(x<=Lw-d1)bars.push(x);}
    const Abi=As/bars.length;
    const phiC=0.65;
    const Pn0=0.85*fc*(Lw*t-As)+As*fy;
    const PnMax=0.8*Pn0;
    const phiPnMax=phiC*PnMax/1000;
    pts.push({P:phiPnMax,M:0});
    nom.push({P:PnMax/1000,M:0});

    for(let c=Lw*2;c>=0.1;c-=Lw/40){
        const a=b1*c;
        let Pn=0.85*fc*a*t;
        let Mni=0.85*fc*a*t*(Lw/2-a/2);
        for(const di of bars){
            const es=ecu*(c-di)/c;
            let fs=Math.max(-fy,Math.min(fy,Es*es));
            Pn+=di<=a?Abi*(fs-0.85*fc):Abi*fs;
            Mni+=Abi*fs*(Lw/2-di);
        }
        const dMax=Math.max(...bars);
        const et=ecu*(dMax-c)/c;
        const phi=et>=0.005?0.9:et<=0.002?0.65:0.65+(et-0.002)*0.25/0.003;
        const Pk=Pn/1000,Mk=Mni/12000;
        if(phi*Pk<=phiPnMax&&phi*Pk>=-phiC*As*fy/1000){
            pts.push({P:phi*Pk,M:Math.abs(phi*Mk)});
            nom.push({P:Pk,M:Math.abs(Mk)});
        }
    }
    const phiPnT=-0.9*As*fy/1000;
    pts.push({P:phiPnT,M:0});
    nom.push({P:-As*fy/1000,M:0});
    const bal=pts.reduce((p,c)=>Math.abs(c.M)>Math.abs(p.M)?c:p);
    const pure=pts.filter(p=>Math.abs(p.P)<phiPnMax*0.05).reduce((p,c)=>Math.abs(c.M)>Math.abs(p.M)?c:p,{P:0,M:0});
    return{pts,nom,pureComp:phiPnMax,bal,pureBend:pure,pureTens:phiPnT};
}

function calcPM_OP(t,fc,fy,AsPerFt,cover,dbH,dbV,layers){
    // Out-of-plane P-M for 12" width strip
    const pts=[],nom=[];
    const Es=29e6,ecu=0.003;
    const b=12; // per foot width
    const b1=Math.max(0.65,Math.min(0.85,0.85-0.05*(fc-4000)/1000));
    const d1=cover+dbH+dbV/2;
    const d2=t-d1;
    
    // Bar positions for double layer
    const bars=layers===2?[d1,t-d1]:[t/2];
    const Abi=AsPerFt/layers;
    
    const phiC=0.65;
    const Ag=b*t;
    const Pn0=0.85*fc*(Ag-AsPerFt)+AsPerFt*fy;
    const PnMax=0.8*Pn0;
    const phiPnMax=phiC*PnMax/1000;
    pts.push({P:phiPnMax,M:0});
    nom.push({P:PnMax/1000,M:0});

    for(let c=t*3;c>=0.05;c-=t/30){
        const a=b1*c;
        let Pn=0.85*fc*Math.min(a,t)*b;
        let Mni=0.85*fc*Math.min(a,t)*b*(t/2-Math.min(a,t)/2);
        
        for(const di of bars){
            const es=ecu*(c-di)/c;
            let fs=Math.max(-fy,Math.min(fy,Es*es));
            if(di<=a){
                Pn+=Abi*(fs-0.85*fc);
            }else{
                Pn+=Abi*fs;
            }
            Mni+=Abi*fs*(t/2-di);
        }
        
        const dMax=Math.max(...bars);
        const et=ecu*(dMax-c)/c;
        const phi=et>=0.005?0.9:et<=0.002?0.65:0.65+(et-0.002)*0.25/0.003;
        const Pk=Pn/1000,Mk=Mni/12000;
        
        if(phi*Pk<=phiPnMax&&phi*Pk>=-phiC*AsPerFt*fy/1000&&!isNaN(Pk)&&!isNaN(Mk)){
            pts.push({P:phi*Pk,M:Math.abs(phi*Mk)});
            nom.push({P:Pk,M:Math.abs(Mk)});
        }
    }
    
    const phiPnT=-0.9*AsPerFt*fy/1000;
    pts.push({P:phiPnT,M:0});
    nom.push({P:-AsPerFt*fy/1000,M:0});
    
    const bal=pts.reduce((p,c)=>Math.abs(c.M)>Math.abs(p.M)?c:p);
    const pure=pts.filter(p=>Math.abs(p.P)<phiPnMax*0.1).reduce((p,c)=>Math.abs(c.M)>Math.abs(p.M)?c:p,{P:0,M:0});
    return{pts,nom,pureComp:phiPnMax,bal,pureBend:pure,pureTens:phiPnT};
}

function checkPM(pm,Pu,Mu){
    let cap=0;
    for(let i=0;i<pm.pts.length-1;i++){
        const p1=pm.pts[i],p2=pm.pts[i+1];
        if((p1.P>=Pu&&p2.P<=Pu)||(p1.P<=Pu&&p2.P>=Pu)){
            const ti=(Pu-p1.P)/(p2.P-p1.P);
            cap=Math.max(cap,p1.M+ti*(p2.M-p1.M));
        }
    }
    const ratio=Mu/Math.max(cap,0.001);
    return{pass:ratio<=1,ratio,cap};
}

function updateUI(){
    document.getElementById('placeholder').style.display='none';
    document.getElementById('results').style.display='block';
    const r=R;
    const allPass=r.rAxial<=1&&r.rMomIP<=1&&r.rShearIP<=1&&r.rMomOP<=1&&r.rShearOP<=1&&r.pmCheck.pass&&r.pmopCheck.pass&&r.deflOK;
    const st=document.getElementById('status');
    st.textContent=allPass?'DESIGN OK':'DESIGN NG';
    st.className='badge '+(allPass?'badge-pass':'badge-fail');

    // Summary grid
    const cards=[
        {t:'Axial',v:r.phiPn.toFixed(0),u:'œÜPn (kips)',r:r.rAxial,i:'P',c:'blue'},
        {t:'In-Plane Moment',v:r.phiMn.toFixed(0),u:'œÜMn (k-ft)',r:r.rMomIP,i:'M',c:'purple'},
        {t:'In-Plane Shear',v:r.phiVn.toFixed(0),u:'œÜVn (kips)',r:r.rShearIP,i:'V',c:'orange'},
        {t:'Out-Plane Moment',v:r.phiMnOP.toFixed(2),u:'œÜMn (k-ft/ft)',r:r.rMomOP,i:'M',c:'green'},
        {t:'Out-Plane Shear',v:r.phiVcOP.toFixed(2),u:'œÜVn (k/ft)',r:r.rShearOP,i:'V',c:'cyan'},
        {t:'Slenderness',v:r.klc_t.toFixed(1),u:'k¬∑lc/t (limit 25)',r:r.klc_t/25,i:'Œª',c:'purple'},
        {t:'Deflection',v:r.delta_calc.toFixed(3),u:`Œ¥ (in) vs ${r.delta_allow.toFixed(3)}"`,r:r.rDefl,i:'Œî',c:'blue'},
        {t:'P-M (Out-Plane)',v:r.pmopCheck.ratio.toFixed(2),u:'Interaction Ratio',r:r.pmopCheck.ratio,i:'‚äï',c:'orange'}
    ];
    document.getElementById('summaryGrid').innerHTML=cards.map(c=>`
        <div class="card">
            <div class="card-header"><span class="card-title">${c.t}</span><div class="card-icon icon-${c.c}">${c.i}</div></div>
            <div class="card-value">${c.v}</div>
            <div class="card-detail">${c.u}</div>
            <div class="ratio-bar"><div class="ratio-fill ${c.r<=0.75?'ratio-safe':c.r<=1?'ratio-warn':'ratio-fail'}" style="width:${Math.min(c.r*100,100)}%"></div></div>
            <div class="card-detail" style="margin-top:5px">D/C: ${c.r.toFixed(3)}</div>
        </div>
    `).join('');

    document.getElementById('propsCard').innerHTML=`
        <div class="card-header"><span class="card-title">Section Properties</span></div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px">
            <div><div class="card-detail">Ag</div><div style="font-family:monospace">${r.Ag.toFixed(0)} in¬≤</div></div>
            <div><div class="card-detail">As,vert</div><div style="font-family:monospace">${r.As.toFixed(2)} in¬≤</div></div>
            <div><div class="card-detail">œÅv</div><div style="font-family:monospace">${(r.rhoV*100).toFixed(3)}%</div></div>
            <div><div class="card-detail">Hw/Lw</div><div style="font-family:monospace">${r.AR.toFixed(2)}</div></div>
        </div>
        <div class="card-header" style="margin-top:14px"><span class="card-title">Minimum Reinforcement (ACI 11.6)</span></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
            <div style="padding:8px;background:var(--bg);border-radius:6px">
                <div class="card-detail">Vertical Steel</div>
                <div style="font-family:monospace;font-size:11px;margin-top:4px">œÅv = ${(r.rhoV*100).toFixed(4)}% ‚â• ${(r.rhoVmin*100).toFixed(2)}%</div>
                <div style="margin-top:4px"><span class="${r.rhoV>=r.rhoVmin?'pass':'fail'}" style="font-size:11px;font-weight:600">${r.rhoV>=r.rhoVmin?'‚úì OK':'‚úó NG'}</span></div>
            </div>
            <div style="padding:8px;background:var(--bg);border-radius:6px">
                <div class="card-detail">Horizontal Steel</div>
                <div style="font-family:monospace;font-size:11px;margin-top:4px">œÅh = ${(r.rhoH*100).toFixed(4)}% ‚â• ${(r.rhoHmin*100).toFixed(2)}%</div>
                <div style="margin-top:4px"><span class="${r.rhoH>=r.rhoHmin?'pass':'fail'}" style="font-size:11px;font-weight:600">${r.rhoH>=r.rhoHmin?'‚úì OK':'‚úó NG'}</span></div>
            </div>
            <div style="padding:8px;background:var(--bg);border-radius:6px">
                <div class="card-detail">Max Spacing (s ‚â§ min(18", 3t))</div>
                <div style="font-family:monospace;font-size:11px;margin-top:4px">sv=${r.vSpac}", sh=${r.hSpac}" ‚â§ ${Math.min(18,3*r.t).toFixed(0)}"</div>
                <div style="margin-top:4px"><span class="${r.vSpac<=Math.min(18,3*r.t)&&r.hSpac<=Math.min(18,3*r.t)?'pass':'fail'}" style="font-size:11px;font-weight:600">${r.vSpac<=Math.min(18,3*r.t)&&r.hSpac<=Math.min(18,3*r.t)?'‚úì OK':'‚úó NG'}</span></div>
            </div>
            <div style="padding:8px;background:var(--bg);border-radius:6px">
                <div class="card-detail">Layers (t>${'10"‚Üí2 layers'})</div>
                <div style="font-family:monospace;font-size:11px;margin-top:4px">t=${r.t}", layers=${r.vLay}</div>
                <div style="margin-top:4px"><span class="${r.t<=10||r.vLay>=2?'pass':'fail'}" style="font-size:11px;font-weight:600">${r.t<=10||r.vLay>=2?'‚úì OK':'‚úó Need 2 layers'}</span></div>
            </div>
        </div>`;

    // In-plane tab
    document.getElementById('inplaneCard').innerHTML=`
        <div class="calc-title">In-Plane Flexure (ACI 11.5.2)</div>
        <div class="calc-line">As = ${r.As.toFixed(2)} in¬≤, d = ${r.d.toFixed(2)} in</div>
        <div class="calc-line">a = ${r.a.toFixed(2)} in, Mn = ${r.Mn.toFixed(0)} k-ft</div>
        <div class="calc-line">œÜMn = <span class="result">${r.phiMn.toFixed(0)} k-ft</span>, Mu = ${r.MuIP} k-ft</div>
        <div class="calc-line">D/C = ${r.rMomIP.toFixed(3)} ‚Üí <span class="${r.rMomIP<=1?'pass':'fail'}">${r.rMomIP<=1?'OK':'NG'}</span></div>
        <div class="calc-title" style="margin-top:14px">In-Plane Shear (ACI 11.5.4)</div>
        <div class="calc-line">Hw/Lw = ${r.AR.toFixed(2)}, Œ±c = ${r.alphaC.toFixed(2)}</div>
        <div class="calc-line">Vc = ${r.Vc.toFixed(1)} k, Vs = ${r.Vs.toFixed(1)} k</div>
        <div class="calc-line">Vn = ${r.Vn.toFixed(1)} k (max ${r.VnMax.toFixed(1)} k)</div>
        <div class="calc-line">œÜVn = <span class="result">${r.phiVn.toFixed(1)} k</span>, Vu = ${r.VuIP} k</div>
        <div class="calc-line">D/C = ${r.rShearIP.toFixed(3)} ‚Üí <span class="${r.rShearIP<=1?'pass':'fail'}">${r.rShearIP<=1?'OK':'NG'}</span></div>`;

    // Out-of-plane tab
    document.getElementById('outplaneCard').innerHTML=`
        <div class="calc-title">Out-of-Plane Flexure (per ft)</div>
        <div class="calc-line">As/ft = ${r.AsPerFt.toFixed(3)} in¬≤/ft, d = ${r.dOP.toFixed(2)} in</div>
        <div class="calc-line">a = ${r.aOP.toFixed(3)} in</div>
        <div class="calc-line">œÜMn = <span class="result">${r.phiMnOP.toFixed(2)} k-ft/ft</span>, Mu = ${r.MuOP} k-ft/ft</div>
        <div class="calc-line">D/C = ${r.rMomOP.toFixed(3)} ‚Üí <span class="${r.rMomOP<=1?'pass':'fail'}">${r.rMomOP<=1?'OK':'NG'}</span></div>
        <div class="calc-title" style="margin-top:14px">Out-of-Plane Shear (per ft)</div>
        <div class="calc-line">Vc = ${r.VcOP.toFixed(2)} k/ft</div>
        <div class="calc-line">œÜVc = <span class="result">${r.phiVcOP.toFixed(2)} k/ft</span>, Vu = ${r.VuOP} k/ft</div>
        <div class="calc-line">D/C = ${r.rShearOP.toFixed(3)} ‚Üí <span class="${r.rShearOP<=1?'pass':'fail'}">${r.rShearOP<=1?'OK':'NG'}</span></div>
        <div class="calc-title" style="margin-top:14px">P-M Interaction (Out-of-Plane)</div>
        <div class="calc-line">Pu/ft = ${r.PuPerFt.toFixed(2)} k/ft</div>
        <div class="calc-line">œÜMn @ Pu = ${r.pmopCheck.cap.toFixed(2)} k-ft/ft</div>
        <div class="calc-line">Ratio = ${r.pmopCheck.ratio.toFixed(3)} ‚Üí <span class="${r.pmopCheck.pass?'pass':'fail'}">${r.pmopCheck.pass?'OK':'NG'}</span></div>`;

    // Deflection card
    const isCracked = r.Ma_svc > r.Mcr;
    document.getElementById('deflectionCard').innerHTML=`
        <div class="calc-title">Service Load Deflection (ACI 318-19 Section 24.2)</div>
        <div class="calc-line">Ma,service = ${r.Ma_svc} k-ft/ft</div>
        <div class="calc-line">Ec = 57000‚àöf'c = 57000√ó‚àö${r.fc} = ${(r.Ec/1000).toFixed(0)} ksi</div>
        <div class="calc-line">n = Es/Ec = ${r.Es/1000}/${(r.Ec/1000).toFixed(0)} = ${r.n.toFixed(2)}</div>
        
        <div class="calc-title" style="margin-top:14px">Gross Moment of Inertia (per ft width)</div>
        <div class="calc-line">Ig = b¬∑t¬≥/12 = 12√ó${r.t}¬≥/12 = <span class="result">${r.Ig.toFixed(1)} in‚Å¥</span></div>
        
        <div class="calc-title" style="margin-top:14px">Cracking Moment (ACI 24.2.3.5)</div>
        <div class="calc-line">fr = 7.5¬∑Œª¬∑‚àöf'c = 7.5√ó${r.lambda}√ó‚àö${r.fc} = ${r.fr.toFixed(0)} psi</div>
        <div class="calc-line">Mcr = fr¬∑Ig/(t/2) = ${r.fr.toFixed(0)}√ó${r.Ig.toFixed(1)}/(${r.t}/2)/12000</div>
        <div class="calc-line">Mcr = <span class="result">${r.Mcr.toFixed(3)} k-ft/ft</span></div>
        
        <div class="calc-title" style="margin-top:14px">Cracking Check</div>
        <div class="calc-line">Ma = ${r.Ma_svc} k-ft/ft ${isCracked?'>':'‚â§'} Mcr = ${r.Mcr.toFixed(3)} k-ft/ft</div>
        <div class="calc-line" style="color:${isCracked?'var(--orange)':'var(--green)'};font-weight:600">
            ‚Üí Section is ${isCracked?'CRACKED':'UNCRACKED'}
        </div>
        
        ${isCracked ? `
        <div class="calc-title" style="margin-top:14px">Cracked Moment of Inertia (ACI 24.2.3.5)</div>
        <div class="calc-line">œÅ = As/(b¬∑d) = ${r.AsPerFt.toFixed(3)}/(12√ó${r.dOP.toFixed(2)}) = ${(r.AsPerFt/(12*r.dOP)).toFixed(5)}</div>
        <div class="calc-line">k = ‚àö(2œÅn+(œÅn)¬≤) - œÅn</div>
        <div class="calc-line">k = ‚àö(2√ó${(r.AsPerFt/(12*r.dOP)).toFixed(5)}√ó${r.n.toFixed(2)}+...) = ${r.kCr.toFixed(4)}</div>
        <div class="calc-line">c = k¬∑d = ${r.kCr.toFixed(4)}√ó${r.dOP.toFixed(2)} = ${(r.kCr*r.dOP).toFixed(3)} in (N.A. depth)</div>
        <div class="calc-line">Icr = b¬∑c¬≥/3 + n¬∑As¬∑(d-c)¬≤</div>
        <div class="calc-line">Icr = 12√ó${(r.kCr*r.dOP).toFixed(3)}¬≥/3 + ${r.n.toFixed(2)}√ó${r.AsPerFt.toFixed(3)}√ó(${r.dOP.toFixed(2)}-${(r.kCr*r.dOP).toFixed(3)})¬≤</div>
        <div class="calc-line">Icr = <span class="result">${r.Icr.toFixed(2)} in‚Å¥</span></div>
        
        <div class="calc-title" style="margin-top:14px">Effective Moment of Inertia - Branson's Eq. (ACI 24.2.3.5)</div>
        <div class="calc-line">Ie = (Mcr/Ma)¬≥¬∑Ig + [1-(Mcr/Ma)¬≥]¬∑Icr ‚â§ Ig</div>
        <div class="calc-line">Ie = (${r.Mcr.toFixed(3)}/${r.Ma_svc})¬≥√ó${r.Ig.toFixed(1)} + [1-(${r.Mcr.toFixed(3)}/${r.Ma_svc})¬≥]√ó${r.Icr.toFixed(2)}</div>
        <div class="calc-line">Ie = ${Math.pow(r.Mcr/r.Ma_svc,3).toFixed(4)}√ó${r.Ig.toFixed(1)} + ${(1-Math.pow(r.Mcr/r.Ma_svc,3)).toFixed(4)}√ó${r.Icr.toFixed(2)}</div>
        <div class="calc-line">Ie = <span class="result">${r.Ie.toFixed(2)} in‚Å¥</span> (using cracked section)</div>
        ` : `
        <div class="calc-title" style="margin-top:14px">Effective Moment of Inertia</div>
        <div class="calc-line">Since Ma ‚â§ Mcr, section is uncracked</div>
        <div class="calc-line">Ie = Ig = <span class="result">${r.Ig.toFixed(1)} in‚Å¥</span> (using gross section)</div>
        `}
        
        <div class="calc-title" style="margin-top:14px">Deflection Calculation</div>
        <div class="calc-line">For simply supported with uniform moment:</div>
        <div class="calc-line">Œ¥ = M¬∑L¬≤/(8¬∑Ec¬∑Ie)</div>
        <div class="calc-line">Œ¥ = ${r.Ma_svc}√ó12000√ó${r.lc}¬≤/(8√ó${(r.Ec).toFixed(0)}√ó${r.Ie.toFixed(2)})</div>
        <div class="calc-line">Œ¥ = <span class="result">${r.delta_calc.toFixed(4)} in</span></div>
        
        <div class="calc-title" style="margin-top:14px">Deflection Check (ACI Table 24.2.2)</div>
        <div class="calc-line">Œ¥_allow = L/${r.deflLimit} = ${r.lc}/${r.deflLimit} = ${r.delta_allow.toFixed(4)} in</div>
        <div class="calc-line">Œ¥/Œ¥_allow = ${r.delta_calc.toFixed(4)}/${r.delta_allow.toFixed(4)} = ${r.rDefl.toFixed(3)}</div>
        <div class="calc-line">Check: ${r.delta_calc.toFixed(4)}" ‚â§ ${r.delta_allow.toFixed(4)}" ‚Üí <span class="${r.deflOK?'pass':'fail'}" style="font-weight:600">${r.deflOK?'OK':'NG'}</span></div>
        
        <div class="deflection-diagram">
            <canvas id="deflCanvas" width="300" height="180"></canvas>
        </div>`;
    
    setTimeout(drawDeflection,50);

    // Slenderness tab
    document.getElementById('slenderCard').innerHTML=`
        <div class="calc-title">Slenderness (ACI 11.4)</div>
        <div class="calc-line">k¬∑lc/t = ${r.k}√ó${r.lc}/${r.t} = <span class="result">${r.klc_t.toFixed(2)}</span></div>
        <div class="calc-line">Limit = 25 (Simplified Method)</div>
        <div class="calc-line">Status: <span class="${r.slenderOK?'pass':'fail'}">${r.slenderOK?'Non-slender':'Slender'}</span></div>
        ${!r.slenderOK?`<div class="calc-line">Cr = [1-(klc/32t)¬≤] = ${r.Cr.toFixed(3)}</div>`:''}
        <div class="calc-title" style="margin-top:14px">Min Thickness (11.3.1)</div>
        <div class="calc-line">t ‚â• 4" and lc/25 = ${(r.lc/25).toFixed(2)}"</div>
        <div class="calc-line">Provided: ${r.t}" ‚Üí <span class="${r.t>=4&&r.t>=r.lc/25?'pass':'fail'}">${r.t>=4&&r.t>=r.lc/25?'OK':'NG'}</span></div>`;

    // PM In-plane legend
    const pm=r.pm;
    document.getElementById('pmComp').textContent=pm.pureComp.toFixed(0)+' k';
    document.getElementById('pmBal').textContent=`P=${pm.bal.P.toFixed(0)}k, M=${pm.bal.M.toFixed(0)}k-ft`;
    document.getElementById('pmBend').textContent=pm.pureBend.M.toFixed(0)+' k-ft';
    document.getElementById('pmTens').textContent=pm.pureTens.toFixed(0)+' k';
    document.getElementById('pmApp').textContent=`Pu=${r.Pu}k, Mu=${r.MuIP}k-ft`;
    const pmSt=document.getElementById('pmStatus');
    pmSt.textContent=r.pmCheck.pass?'INSIDE':'OUTSIDE';
    pmSt.className='badge '+(r.pmCheck.pass?'badge-pass':'badge-fail');

    // PM Out-of-plane legend
    const pmop=r.pmOP;
    document.getElementById('pmopComp').textContent=pmop.pureComp.toFixed(2)+' k/ft';
    document.getElementById('pmopBal').textContent=`P=${pmop.bal.P.toFixed(1)}k, M=${pmop.bal.M.toFixed(2)}k-ft`;
    document.getElementById('pmopBend').textContent=pmop.pureBend.M.toFixed(2)+' k-ft/ft';
    document.getElementById('pmopTens').textContent=pmop.pureTens.toFixed(2)+' k/ft';
    document.getElementById('pmopApp').textContent=`P=${r.PuPerFt.toFixed(1)}k/ft, M=${r.MuOP}k-ft/ft`;
    const pmopSt=document.getElementById('pmopStatus');
    pmopSt.textContent=r.pmopCheck.pass?'INSIDE':'OUTSIDE';
    pmopSt.className='badge '+(r.pmopCheck.pass?'badge-pass':'badge-fail');

    // Report
    const vBarOK=r.rhoV>=r.rhoVmin;
    const hBarOK=r.rhoH>=r.rhoHmin;
    const spacOK_v=r.vSpac<=Math.min(18,3*r.t);
    const spacOK_h=r.hSpac<=Math.min(18,3*r.t);
    const maxSpac=Math.min(18,3*r.t);
    
    document.getElementById('reportCard').innerHTML=`
        <div class="calc-title">1. Input Summary</div>
        <div class="calc-line">Wall: ${r.Lw}"√ó${r.t}"√ó${r.Hw}", f'c=${r.fc}psi, fy=${r.fy}psi</div>
        <div class="calc-line">Vert: #${r.vBar}@${r.vSpac}"(${r.vLay}L), Horiz: #${r.hBar}@${r.hSpac}"</div>
        <div class="calc-title">2. Section Properties</div>
        <div class="calc-line">Ag = Lw √ó t = ${r.Lw} √ó ${r.t} = ${r.Ag.toFixed(0)} in¬≤</div>
        <div class="calc-line">As,vert = ${r.nBars} bars √ó ${Ab[r.vBar]} in¬≤ √ó ${r.vLay} layers = ${r.As.toFixed(2)} in¬≤</div>
        <div class="calc-line">As,horiz = ${(r.Hw/r.hSpac).toFixed(0)} bars √ó ${Ab[r.hBar]} in¬≤ √ó ${r.vLay} layers = ${r.AsH.toFixed(2)} in¬≤</div>
        <div class="calc-title">3. Minimum Reinforcement Check (ACI 318-19 Section 11.6)</div>
        <div class="calc-line" style="color:var(--blue)">‚ñ∏ Vertical (Longitudinal) Reinforcement - ACI 11.6.1</div>
        <div class="calc-line">  For fy ‚â• 60 ksi and bar ‚â§ #5: œÅ‚Ñì,min = 0.0012</div>
        <div class="calc-line">  For other cases: œÅ‚Ñì,min = 0.0015</div>
        <div class="calc-line">  Applied: fy = ${r.fy/1000} ksi, Bar = #${r.vBar} ‚Üí œÅ‚Ñì,min = ${(r.rhoVmin*100).toFixed(2)}%</div>
        <div class="calc-line">  œÅ‚Ñì,provided = As/(Lw√ót) = ${r.As.toFixed(2)}/${r.Ag.toFixed(0)} = <span class="result">${(r.rhoV*100).toFixed(4)}%</span></div>
        <div class="calc-line">  Check: ${(r.rhoV*100).toFixed(4)}% ‚â• ${(r.rhoVmin*100).toFixed(2)}% ‚Üí <span class="${vBarOK?'pass':'fail'}">${vBarOK?'OK':'NG'}</span></div>
        <div class="calc-line" style="color:var(--blue);margin-top:8px">‚ñ∏ Horizontal (Transverse) Reinforcement - ACI 11.6.2</div>
        <div class="calc-line">  For fy ‚â• 60 ksi and bar ‚â§ #5: œÅt,min = 0.0020</div>
        <div class="calc-line">  For other cases: œÅt,min = 0.0025</div>
        <div class="calc-line">  Applied: fy = ${r.fy/1000} ksi, Bar = #${r.hBar} ‚Üí œÅt,min = ${(r.rhoHmin*100).toFixed(2)}%</div>
        <div class="calc-line">  œÅt,provided = As/(Hw√ót) = ${r.AsH.toFixed(2)}/${(r.Hw*r.t).toFixed(0)} = <span class="result">${(r.rhoH*100).toFixed(4)}%</span></div>
        <div class="calc-line">  Check: ${(r.rhoH*100).toFixed(4)}% ‚â• ${(r.rhoHmin*100).toFixed(2)}% ‚Üí <span class="${hBarOK?'pass':'fail'}">${hBarOK?'OK':'NG'}</span></div>
        <div class="calc-line" style="color:var(--blue);margin-top:8px">‚ñ∏ Maximum Spacing - ACI 11.7.2.1</div>
        <div class="calc-line">  s,max = min(18", 3t) = min(18, 3√ó${r.t}) = ${maxSpac.toFixed(1)}"</div>
        <div class="calc-line">  Vertical spacing: ${r.vSpac}" ‚â§ ${maxSpac.toFixed(1)}" ‚Üí <span class="${spacOK_v?'pass':'fail'}">${spacOK_v?'OK':'NG'}</span></div>
        <div class="calc-line">  Horizontal spacing: ${r.hSpac}" ‚â§ ${maxSpac.toFixed(1)}" ‚Üí <span class="${spacOK_h?'pass':'fail'}">${spacOK_h?'OK':'NG'}</span></div>
        <div class="calc-line" style="color:var(--blue);margin-top:8px">‚ñ∏ Number of Layers - ACI 11.7.2.3</div>
        <div class="calc-line">  For t > 10": Two layers required (each face)</div>
        <div class="calc-line">  Provided: t = ${r.t}", Layers = ${r.vLay} ‚Üí <span class="${(r.t<=10||r.vLay>=2)?'pass':'fail'}">${(r.t<=10||r.vLay>=2)?'OK':'NG - Need 2 layers'}</span></div>
        <div class="calc-line" style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
          <strong>Min. Reinforcement Summary:</strong> <span class="${vBarOK&&hBarOK&&spacOK_v&&spacOK_h&&(r.t<=10||r.vLay>=2)?'pass':'fail'}">${vBarOK&&hBarOK&&spacOK_v&&spacOK_h&&(r.t<=10||r.vLay>=2)?'‚úì ALL REQUIREMENTS SATISFIED':'‚úó REQUIREMENTS NOT MET'}</span>
        </div>
        <div class="calc-title">4. Slenderness Check (ACI 318-19 Section 11.4)</div>
        <div class="calc-line">k¬∑lc/t = ${r.k}√ó${r.lc}/${r.t} = <span class="result">${r.klc_t.toFixed(2)}</span></div>
        <div class="calc-line">Limit for Simplified Design = 25 (ACI 11.5.3.1)</div>
        <div class="calc-line">Status: ${r.klc_t.toFixed(2)} ${r.slenderOK?'‚â§':'>'} 25 ‚Üí <span class="${r.slenderOK?'pass':'fail'}">${r.slenderOK?'Non-slender, OK':'Slender - Use 11.8'}</span></div>
        ${!r.slenderOK?`<div class="calc-line">Reduction: Cr = [1-(klc/32t)¬≤] = [1-(${r.klc_t.toFixed(2)}/32)¬≤] = ${r.Cr.toFixed(3)}</div>`:''}
        <div class="calc-title">5. Strength Design Summary</div>
        <div class="calc-line">Axial: œÜPn=${r.phiPn.toFixed(0)}k, Pu=${r.Pu}k, D/C=${r.rAxial.toFixed(3)} <span class="${r.rAxial<=1?'pass':'fail'}">${r.rAxial<=1?'OK':'NG'}</span></div>
        <div class="calc-line">IP Moment: œÜMn=${r.phiMn.toFixed(0)}k-ft, Mu=${r.MuIP}k-ft, D/C=${r.rMomIP.toFixed(3)} <span class="${r.rMomIP<=1?'pass':'fail'}">${r.rMomIP<=1?'OK':'NG'}</span></div>
        <div class="calc-line">IP Shear: œÜVn=${r.phiVn.toFixed(1)}k, Vu=${r.VuIP}k, D/C=${r.rShearIP.toFixed(3)} <span class="${r.rShearIP<=1?'pass':'fail'}">${r.rShearIP<=1?'OK':'NG'}</span></div>
        <div class="calc-line">OP Moment: œÜMn=${r.phiMnOP.toFixed(2)}k-ft/ft, Mu=${r.MuOP}k-ft/ft, D/C=${r.rMomOP.toFixed(3)} <span class="${r.rMomOP<=1?'pass':'fail'}">${r.rMomOP<=1?'OK':'NG'}</span></div>
        <div class="calc-line">OP Shear: œÜVn=${r.phiVcOP.toFixed(2)}k/ft, Vu=${r.VuOP}k/ft, D/C=${r.rShearOP.toFixed(3)} <span class="${r.rShearOP<=1?'pass':'fail'}">${r.rShearOP<=1?'OK':'NG'}</span></div>
        <div class="calc-line">P-M IP: Ratio=${r.pmCheck.ratio.toFixed(3)} <span class="${r.pmCheck.pass?'pass':'fail'}">${r.pmCheck.pass?'OK':'NG'}</span></div>
        <div class="calc-line">P-M OP: Ratio=${r.pmopCheck.ratio.toFixed(3)} <span class="${r.pmopCheck.pass?'pass':'fail'}">${r.pmopCheck.pass?'OK':'NG'}</span></div>
        <div class="calc-title">6. Serviceability - Deflection (ACI 318-19 Section 24.2)</div>
        <div class="calc-line" style="color:var(--blue)">‚ñ∏ Material Properties</div>
        <div class="calc-line">  Ec = 57000‚àöf'c = ${(r.Ec/1000).toFixed(0)} ksi</div>
        <div class="calc-line">  n = Es/Ec = ${r.n.toFixed(2)}</div>
        <div class="calc-line" style="color:var(--blue);margin-top:8px">‚ñ∏ Section Properties (per ft width)</div>
        <div class="calc-line">  Ig = b¬∑t¬≥/12 = ${r.Ig.toFixed(1)} in‚Å¥</div>
        <div class="calc-line">  fr = 7.5¬∑Œª¬∑‚àöf'c = ${r.fr.toFixed(0)} psi</div>
        <div class="calc-line">  Mcr = fr¬∑Ig/(t/2) = ${r.Mcr.toFixed(3)} k-ft/ft</div>
        <div class="calc-line" style="color:var(--blue);margin-top:8px">‚ñ∏ Cracking Check</div>
        <div class="calc-line">  Ma,service = ${r.Ma_svc} k-ft/ft</div>
        <div class="calc-line">  Ma ${r.Ma_svc>r.Mcr?'>':'‚â§'} Mcr ‚Üí Section is <span class="${r.Ma_svc>r.Mcr?'warn':'pass'}">${r.Ma_svc>r.Mcr?'CRACKED':'UNCRACKED'}</span></div>
        ${r.Ma_svc>r.Mcr?`
        <div class="calc-line" style="color:var(--blue);margin-top:8px">‚ñ∏ Cracked Section Analysis</div>
        <div class="calc-line">  k = ${r.kCr.toFixed(4)}, c = k¬∑d = ${(r.kCr*r.dOP).toFixed(3)} in</div>
        <div class="calc-line">  Icr = b¬∑c¬≥/3 + n¬∑As¬∑(d-c)¬≤ = ${r.Icr.toFixed(2)} in‚Å¥</div>
        <div class="calc-line" style="color:var(--blue);margin-top:8px">‚ñ∏ Effective Moment of Inertia (Branson's Eq.)</div>
        <div class="calc-line">  Ie = (Mcr/Ma)¬≥¬∑Ig + [1-(Mcr/Ma)¬≥]¬∑Icr</div>
        <div class="calc-line">  Ie = ${r.Ie.toFixed(2)} in‚Å¥ <span class="warn">(Cracked Section Used)</span></div>
        `:`
        <div class="calc-line" style="color:var(--blue);margin-top:8px">‚ñ∏ Effective Moment of Inertia</div>
        <div class="calc-line">  Ie = Ig = ${r.Ig.toFixed(1)} in‚Å¥ <span class="pass">(Gross Section Used)</span></div>
        `}
        <div class="calc-line" style="color:var(--blue);margin-top:8px">‚ñ∏ Deflection Calculation</div>
        <div class="calc-line">  Œ¥ = M¬∑L¬≤/(8¬∑Ec¬∑Ie) = ${r.delta_calc.toFixed(4)} in</div>
        <div class="calc-line">  Œ¥_allow = L/${r.deflLimit} = ${r.delta_allow.toFixed(4)} in</div>
        <div class="calc-line">  Check: ${r.delta_calc.toFixed(4)}" ‚â§ ${r.delta_allow.toFixed(4)}" ‚Üí <span class="${r.deflOK?'pass':'fail'}">${r.deflOK?'OK':'NG'}</span></div>
        <div class="calc-title">7. Overall Design Summary</div>
        <div class="calc-line">‚Ä¢ Min. Reinforcement: <span class="${vBarOK&&hBarOK?'pass':'fail'}">${vBarOK&&hBarOK?'OK':'NG'}</span></div>
        <div class="calc-line">‚Ä¢ Slenderness: <span class="${r.slenderOK?'pass':'warn'}">${r.slenderOK?'OK':'Slender'}</span></div>
        <div class="calc-line">‚Ä¢ Axial + Flexure + Shear: <span class="${r.rAxial<=1&&r.rMomIP<=1&&r.rShearIP<=1&&r.rMomOP<=1&&r.rShearOP<=1?'pass':'fail'}">${r.rAxial<=1&&r.rMomIP<=1&&r.rShearIP<=1&&r.rMomOP<=1&&r.rShearOP<=1?'OK':'NG'}</span></div>
        <div class="calc-line">‚Ä¢ P-M Interaction (IP): <span class="${r.pmCheck.pass?'pass':'fail'}">${r.pmCheck.pass?'OK':'NG'}</span></div>
        <div class="calc-line">‚Ä¢ P-M Interaction (OP): <span class="${r.pmopCheck.pass?'pass':'fail'}">${r.pmopCheck.pass?'OK':'NG'}</span></div>
        <div class="calc-line">‚Ä¢ Deflection: <span class="${r.deflOK?'pass':'fail'}">${r.deflOK?'OK':'NG'}</span></div>
        <div class="calc-line" style="margin-top:10px;font-weight:600;font-size:13px">OVERALL DESIGN: <span class="${allPass?'pass':'fail'}">${allPass?'‚úì ADEQUATE':'‚úó INADEQUATE - REVISE'}</span></div>`;
}

function drawDeflection(){
    const canvas=document.getElementById('deflCanvas');
    if(!canvas)return;
    const ctx=canvas.getContext('2d');
    const w=canvas.width,h=canvas.height;
    const r=R;
    
    ctx.fillStyle='#0d1117';
    ctx.fillRect(0,0,w,h);
    
    const pad=30;
    const wallH=h-2*pad;
    const wallW=20;
    const startX=pad+20;
    
    // Draw wall (original position)
    ctx.strokeStyle='#30363d';
    ctx.lineWidth=2;
    ctx.setLineDash([5,5]);
    ctx.beginPath();
    ctx.moveTo(startX,pad);
    ctx.lineTo(startX,h-pad);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Draw deflected shape (parabolic)
    const scale=Math.min(80,r.delta_calc*500);
    ctx.strokeStyle='#58a6ff';
    ctx.lineWidth=3;
    ctx.beginPath();
    for(let y=0;y<=wallH;y+=2){
        const yRatio=y/wallH;
        // Parabolic deflection shape: 4*x*(1-x) for simply supported
        const defl=4*yRatio*(1-yRatio)*scale;
        const x=startX+defl;
        if(y===0)ctx.moveTo(x,pad+y);
        else ctx.lineTo(x,pad+y);
    }
    ctx.stroke();
    
    // Supports
    ctx.fillStyle='#6e7681';
    ctx.beginPath();
    ctx.moveTo(startX-10,pad);ctx.lineTo(startX+10,pad);ctx.lineTo(startX,pad-10);ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(startX-10,h-pad);ctx.lineTo(startX+10,h-pad);ctx.lineTo(startX,h-pad+10);ctx.closePath();
    ctx.fill();
    
    // Max deflection arrow
    const maxDeflX=startX+scale;
    const midY=h/2;
    ctx.strokeStyle='#f85149';
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(startX,midY);
    ctx.lineTo(maxDeflX,midY);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(maxDeflX-6,midY-4);ctx.lineTo(maxDeflX,midY);ctx.lineTo(maxDeflX-6,midY+4);
    ctx.stroke();
    
    // Labels
    ctx.fillStyle='#e6edf3';
    ctx.font='10px system-ui';
    ctx.textAlign='left';
    ctx.fillText(`Œ¥ = ${r.delta_calc.toFixed(4)}"`,maxDeflX+5,midY-5);
    ctx.fillText(`L/${r.deflLimit} = ${r.delta_allow.toFixed(4)}"`,maxDeflX+5,midY+12);
    
    ctx.fillStyle=r.deflOK?'#3fb950':'#f85149';
    ctx.fillText(r.deflOK?'OK':'NG',maxDeflX+5,midY+26);
    
    // Height label
    ctx.fillStyle='#8b949e';
    ctx.save();
    ctx.translate(12,h/2);
    ctx.rotate(-Math.PI/2);
    ctx.textAlign='center';
    ctx.fillText(`lc = ${r.lc}"`,0,0);
    ctx.restore();
}

function drawPM(){
    const canvas=document.getElementById('pmCanvas');
    const ctx=canvas.getContext('2d');
    const pm=R.pm,r=R;
    const w=canvas.width,h=canvas.height,pad=45;
    ctx.fillStyle='#0d1117';ctx.fillRect(0,0,w,h);

    const allP=[...pm.pts.map(p=>p.P),r.Pu];
    const allM=[...pm.pts.map(p=>p.M),r.MuIP];
    const maxP=Math.max(...allP)*1.1,minP=Math.min(...allP,0)*1.1;
    const maxM=Math.max(...allM)*1.1||1;
    const scX=(w-2*pad)/maxM,scY=(h-2*pad)/(maxP-minP);
    const toX=m=>pad+m*scX,toY=p=>h-pad-(p-minP)*scY;

    // Grid
    ctx.strokeStyle='#21262d';ctx.lineWidth=1;
    for(let m=0;m<=maxM;m+=Math.pow(10,Math.floor(Math.log10(maxM)))){ctx.beginPath();ctx.moveTo(toX(m),pad);ctx.lineTo(toX(m),h-pad);ctx.stroke();}
    for(let p=Math.ceil(minP/100)*100;p<=maxP;p+=Math.pow(10,Math.floor(Math.log10(maxP-minP)||1))){ctx.beginPath();ctx.moveTo(pad,toY(p));ctx.lineTo(w-pad,toY(p));ctx.stroke();}

    ctx.strokeStyle='#6e7681';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(pad,toY(0));ctx.lineTo(w-pad,toY(0));ctx.stroke();
    ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad,h-pad);ctx.stroke();

    ctx.strokeStyle='#3fb950';ctx.lineWidth=1;ctx.setLineDash([4,4]);
    ctx.beginPath();pm.nom.forEach((p,i)=>{i===0?ctx.moveTo(toX(p.M),toY(p.P)):ctx.lineTo(toX(p.M),toY(p.P));});ctx.stroke();
    ctx.setLineDash([]);

    ctx.strokeStyle='#58a6ff';ctx.lineWidth=2;
    ctx.beginPath();pm.pts.forEach((p,i)=>{i===0?ctx.moveTo(toX(p.M),toY(p.P)):ctx.lineTo(toX(p.M),toY(p.P));});ctx.stroke();

    ctx.fillStyle='rgba(88,166,255,0.08)';
    ctx.beginPath();pm.pts.forEach((p,i)=>{i===0?ctx.moveTo(toX(p.M),toY(p.P)):ctx.lineTo(toX(p.M),toY(p.P));});ctx.closePath();ctx.fill();

    const px=toX(r.MuIP),py=toY(r.Pu);
    ctx.fillStyle=r.pmCheck.pass?'#3fb950':'#f85149';
    ctx.beginPath();ctx.arc(px,py,6,0,2*Math.PI);ctx.fill();
    ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.beginPath();ctx.arc(px,py,6,0,2*Math.PI);ctx.stroke();

    ctx.fillStyle='#8b949e';ctx.font='10px system-ui';ctx.textAlign='center';
    ctx.fillText('œÜMn (k-ft)',w/2,h-8);
    ctx.save();ctx.translate(10,h/2);ctx.rotate(-Math.PI/2);ctx.fillText('œÜPn (kips)',0,0);ctx.restore();
    ctx.fillStyle='#e6edf3';ctx.textAlign='left';ctx.fillText(`(${r.MuIP}, ${r.Pu})`,px+8,py-4);
}

function drawPMOP(){
    const canvas=document.getElementById('pmopCanvas');
    const ctx=canvas.getContext('2d');
    const pm=R.pmOP,r=R;
    const w=canvas.width,h=canvas.height,pad=45;
    ctx.fillStyle='#0d1117';ctx.fillRect(0,0,w,h);

    const allP=[...pm.pts.map(p=>p.P),r.PuPerFt];
    const allM=[...pm.pts.map(p=>p.M),r.MuOP];
    const maxP=Math.max(...allP)*1.1,minP=Math.min(...allP,0)*1.1;
    const maxM=Math.max(...allM)*1.1||1;
    const scX=(w-2*pad)/maxM,scY=(h-2*pad)/(maxP-minP);
    const toX=m=>pad+m*scX,toY=p=>h-pad-(p-minP)*scY;

    // Grid
    ctx.strokeStyle='#21262d';ctx.lineWidth=1;
    const mStep=Math.pow(10,Math.floor(Math.log10(maxM)));
    for(let m=0;m<=maxM;m+=mStep){ctx.beginPath();ctx.moveTo(toX(m),pad);ctx.lineTo(toX(m),h-pad);ctx.stroke();}
    const pStep=Math.pow(10,Math.floor(Math.log10(Math.abs(maxP-minP)||1)));
    for(let p=Math.ceil(minP/pStep)*pStep;p<=maxP;p+=pStep){ctx.beginPath();ctx.moveTo(pad,toY(p));ctx.lineTo(w-pad,toY(p));ctx.stroke();}

    ctx.strokeStyle='#6e7681';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(pad,toY(0));ctx.lineTo(w-pad,toY(0));ctx.stroke();
    ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad,h-pad);ctx.stroke();

    ctx.strokeStyle='#39d353';ctx.lineWidth=1;ctx.setLineDash([4,4]);
    ctx.beginPath();pm.nom.forEach((p,i)=>{i===0?ctx.moveTo(toX(p.M),toY(p.P)):ctx.lineTo(toX(p.M),toY(p.P));});ctx.stroke();
    ctx.setLineDash([]);

    ctx.strokeStyle='#a371f7';ctx.lineWidth=2;
    ctx.beginPath();pm.pts.forEach((p,i)=>{i===0?ctx.moveTo(toX(p.M),toY(p.P)):ctx.lineTo(toX(p.M),toY(p.P));});ctx.stroke();

    ctx.fillStyle='rgba(163,113,247,0.08)';
    ctx.beginPath();pm.pts.forEach((p,i)=>{i===0?ctx.moveTo(toX(p.M),toY(p.P)):ctx.lineTo(toX(p.M),toY(p.P));});ctx.closePath();ctx.fill();

    const px=toX(r.MuOP),py=toY(r.PuPerFt);
    ctx.fillStyle=r.pmopCheck.pass?'#3fb950':'#f85149';
    ctx.beginPath();ctx.arc(px,py,6,0,2*Math.PI);ctx.fill();
    ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.beginPath();ctx.arc(px,py,6,0,2*Math.PI);ctx.stroke();

    ctx.fillStyle='#8b949e';ctx.font='10px system-ui';ctx.textAlign='center';
    ctx.fillText('œÜMn (k-ft/ft)',w/2,h-8);
    ctx.save();ctx.translate(10,h/2);ctx.rotate(-Math.PI/2);ctx.fillText('œÜPn (k/ft)',0,0);ctx.restore();
    ctx.fillStyle='#e6edf3';ctx.textAlign='left';ctx.fillText(`(${r.MuOP.toFixed(1)}, ${r.PuPerFt.toFixed(1)})`,px+8,py-4);
}

function exportPDF(){
    if(!R.Lw){alert('Calculate first');return;}
    const r=R;
    const allPass=r.rAxial<=1&&r.rMomIP<=1&&r.rShearIP<=1&&r.rMomOP<=1&&r.rShearOP<=1&&r.pmCheck.pass&&r.pmopCheck.pass&&r.deflOK;
    const html=`<!DOCTYPE html><html><head><title>ACI 318 Wall Report</title>
    <style>body{font-family:Arial;margin:30px;font-size:12px}h1{color:#1e3a5f;border-bottom:2px solid #1e3a5f}h2{color:#2563eb;margin-top:20px}table{width:100%;border-collapse:collapse;margin:10px 0}th,td{padding:6px 10px;border:1px solid #ddd;text-align:left}th{background:#f5f5f5}.pass{color:#059669;font-weight:bold}.fail{color:#dc2626;font-weight:bold}.summary{background:#1e3a5f;color:#fff;padding:15px;border-radius:6px;margin-top:20px}</style></head>
    <body><h1>üèóÔ∏è ACI 318-19 Wall Design Report</h1><p>Date: ${new Date().toLocaleDateString()}</p>
    <h2>1. Input</h2><table><tr><td>Wall</td><td>${r.Lw}" √ó ${r.t}" √ó ${r.Hw}"</td><td>f'c</td><td>${r.fc} psi</td></tr><tr><td>Vert. Reinf</td><td>#${r.vBar}@${r.vSpac}" (${r.vLay}L)</td><td>fy</td><td>${r.fy} psi</td></tr></table>
    <h2>2. Strength Design</h2><table><tr><th>Check</th><th>Capacity</th><th>Demand</th><th>D/C</th><th>Status</th></tr>
    <tr><td>Axial</td><td>${r.phiPn.toFixed(0)} k</td><td>${r.Pu} k</td><td>${r.rAxial.toFixed(3)}</td><td class="${r.rAxial<=1?'pass':'fail'}">${r.rAxial<=1?'OK':'NG'}</td></tr>
    <tr><td>IP Moment</td><td>${r.phiMn.toFixed(0)} k-ft</td><td>${r.MuIP} k-ft</td><td>${r.rMomIP.toFixed(3)}</td><td class="${r.rMomIP<=1?'pass':'fail'}">${r.rMomIP<=1?'OK':'NG'}</td></tr>
    <tr><td>IP Shear</td><td>${r.phiVn.toFixed(1)} k</td><td>${r.VuIP} k</td><td>${r.rShearIP.toFixed(3)}</td><td class="${r.rShearIP<=1?'pass':'fail'}">${r.rShearIP<=1?'OK':'NG'}</td></tr>
    <tr><td>OP Moment</td><td>${r.phiMnOP.toFixed(2)} k-ft/ft</td><td>${r.MuOP} k-ft/ft</td><td>${r.rMomOP.toFixed(3)}</td><td class="${r.rMomOP<=1?'pass':'fail'}">${r.rMomOP<=1?'OK':'NG'}</td></tr>
    <tr><td>OP Shear</td><td>${r.phiVcOP.toFixed(2)} k/ft</td><td>${r.VuOP} k/ft</td><td>${r.rShearOP.toFixed(3)}</td><td class="${r.rShearOP<=1?'pass':'fail'}">${r.rShearOP<=1?'OK':'NG'}</td></tr>
    <tr><td>P-M (IP)</td><td>œÜMn@Pu=${r.pmCheck.cap.toFixed(0)} k-ft</td><td>${r.MuIP} k-ft</td><td>${r.pmCheck.ratio.toFixed(3)}</td><td class="${r.pmCheck.pass?'pass':'fail'}">${r.pmCheck.pass?'OK':'NG'}</td></tr>
    <tr><td>P-M (OP)</td><td>œÜMn@Pu=${r.pmopCheck.cap.toFixed(2)} k-ft/ft</td><td>${r.MuOP} k-ft/ft</td><td>${r.pmopCheck.ratio.toFixed(3)}</td><td class="${r.pmopCheck.pass?'pass':'fail'}">${r.pmopCheck.pass?'OK':'NG'}</td></tr></table>
    <h2>3. Serviceability</h2><table><tr><th>Check</th><th>Calculated</th><th>Allowable</th><th>Ratio</th><th>Status</th></tr>
    <tr><td>Deflection</td><td>${r.delta_calc.toFixed(4)}"</td><td>L/${r.deflLimit} = ${r.delta_allow.toFixed(4)}"</td><td>${r.rDefl.toFixed(3)}</td><td class="${r.deflOK?'pass':'fail'}">${r.deflOK?'OK':'NG'}</td></tr></table>
    <h2>4. Deflection Details</h2><table><tr><td>Ig</td><td>${r.Ig.toFixed(1)} in‚Å¥</td><td>Mcr</td><td>${r.Mcr.toFixed(2)} k-ft/ft</td></tr><tr><td>Icr</td><td>${r.Icr.toFixed(1)} in‚Å¥</td><td>Ie</td><td>${r.Ie.toFixed(1)} in‚Å¥</td></tr><tr><td>Section</td><td colspan="3">${r.Ma_svc>r.Mcr?'Cracked':'Uncracked'}</td></tr></table>
    <div class="summary"><strong>Overall: ${allPass?'‚úì ADEQUATE':'‚úó INADEQUATE'}</strong></div>
    <p style="margin-top:30px;color:#666;font-size:10px">Generated by ACI 318-19 Wall Design Tool</p></body></html>`;
    const wnd=window.open();wnd.document.write(html);wnd.document.close();
}
</script>
</body>
</html>
